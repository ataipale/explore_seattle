<!DOCTYPE html>
<meta charset="utf-8">
<style>

body {
  margin: 0;
}

/*.dot {
  stroke: #0000ff;
  z-index: 2;
  fill: none;
}*/

path {
  fill: none;
  stroke: #000;
  stroke-linejoin: round;
  stroke-linecap: round;
}

.major_road { stroke: #776; }
.minor_road { stroke: #ccb; }
.highway { stroke: #f39; stroke-width: 1.5px; }
.rail { stroke: #7de; }

</style>
<body>
<link href="/static/css/bootstrap.min.css" rel="stylesheet" media="screen">
<script src="https://cdnjs.cloudflare.com/ajax/libs/d3/3.5.5/d3.min.js"></script>
<script src="/static/d3.geo.tile.min.js"></script>
<script src="http://code.jquery.com/jquery.js"></script>
<script src="/static/js/bootstrap.min.js"></script>

<script>

// $require('bootstrap')

var width = Math.max(960, window.innerWidth),
    height = Math.max(500, window.innerHeight);

var tiler = d3.geo.tile()
    .size([width, height]);

var projection = d3.geo.mercator()
    .center([-122.2520, 47.6302])
    .scale((1 << 21) / 6 / Math.PI)
    .translate([width / 2, height / 2]);

var path = d3.geo.path()
    .projection(projection);

var svg = d3.select("body").append("svg")
    .attr("width", width)
    .attr("height", height);

var start = new Date().getTime();

svg.selectAll("g")
    .data(tiler
      .scale(projection.scale() * 2 * Math.PI)
      .translate(projection([0, 0])))
  .enter().append("g")
    .each(function(d) {
      var g = d3.select(this);
      d3.json("http://" + ["a", "b", "c"][(d[0] * 31 + d[1]) % 3] + ".tile.openstreetmap.us/vectiles-highroad/" + d[2] + "/" + d[0] + "/" + d[1] + ".json", function(error, json) {
        g.selectAll("path")
            .data(json.features.sort(function(a, b) { return a.properties.sort_key - b.properties.sort_key; }))
          .enter().append("path")
            .attr("class", function(d) { return d.properties.kind; })
            .attr("d", path);
      });
    });

// var end = new Date().getTime();
// var time = end - start;
// console.log('Execution time: ' + time);

console.log("ABOVE");

d3.json("/search", function(error, data) {
  if (error) throw error;
  // console.log(data)

  data.forEach(function(d) {
    d.category = d.categories;
    if (d.location.coordinate){
      d.long = d.location["coordinate"]["longitude"];
      d.lat = d.location["coordinate"]["latitude"];
      d.review_count = d.review_count;
      d.rating = d.rating;
      d.name = d.name;
    }
  });

  // makedots(data);
  process(data);

});

function process(data) {

  var color = ["#ff7f00","#377eb8","#984ea3","#ffff33","#4daf4a","#ffd92f","#00FF00","#00FFFF","#e41a1c", "#08519c"];
  // var start = new Date().getTime();

  var select = d3.select("body").append("select")
      .attr("id", "selecter")
      .on("change", "mouseover");

  var options = select.selectAll("option")
        .data(data);

  options.enter()
          .append("option")
          .attr("value", function(d, i) {
              return d.name;
          })
          .text(function(d, i) {
              return d.name;
          });

  var alertChange = function() {

    var newData = eval(d3.select(this).property('value'));
    console.log(newData);
    alert(newData);
    updateLegend(newData);
  }

  //add this event listener to the first menu (as a whole):
  d3.select("select").on("change", alertChange);

  function updateLegend(newData) {

    // bind data
    var appending = svg.selectAll('.dot')
       .data(newData);

    // add new elements
    appending.enter().append('.dot');

    // update existing elements
    appending.transition()
        .duration(0)
        .style("fill", function(d,i){return color(i);})
        .attr("x",10)
        .attr("y",10)
        .attr("width",function (d) {return d.y; })//d.y;})
        .attr("height",19);

    // remove old elements
    appending.exit().remove();

}

  // var end = new Date().getTime();
  // var time = end - start;
  // console.log('Execution time: ' + time);

  // var start = new Date().getTime();


  var dots = svg.selectAll(".dot")
    .data(data)
    .attr("class", "dot")
    // console.log(data);
    .enter();

  dots.append("circle").style("stroke", function(d){
      // console.log(color[d.rating*2]);
      return color[(d.rating*2) - 1];
      }).style("fill", "none")
    
    .attr("r", function(d){
        var log = d3.scale.log();
        var log2 = log.base(2);
        // console.log(log2(d.review_count));
        return (log2(d.review_count) * 5);
    })
    .attr("cx", function(d){
        // console.log(d);
        // console.log(projection([d.long, d.lat]));
        return projection([d.long, d.lat])[0];
    })
    .attr("cy", function(d){
        return projection([d.long, d.lat])[1];

    })
    .attr("data-toggle","popover")
    .attr("title", function (d) {
      return d.name;
    })
    .attr("data-content", function (d) {
      var categories = [];
        if (d.category){
          if (typeof(d.category[0])==='object'){
            console.log(d.category)
            for (var i = 0; i < d.category.length; i++) {
              console.log(d.category[0]);
              categories.push(d.category[i][0]);
            }
          }

        }
      var cat = "Categories: ";
      var rat = "Rating: "
      return cat.bold() + categories.join(", ") + "<br>" + rat.bold() + d.rating;
    })
    .on("mouseover", function (d) {
      d3.select(this)
        .style("opacity", 0.2);
    })
    .on("mouseout", function (d) {
      d3.select(this)
        .style("opacity", 1);
    });

  // settings for the popover display
  $('[data-toggle="popover"]').popover({trigger: "hover", container: "body", placement: "auto top", title: "TITLE", html: true});

};






    // .enter().append()


</script>
